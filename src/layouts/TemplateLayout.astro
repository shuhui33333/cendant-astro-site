---
import "../styles/global.css";

type NavItem = { href: string; label: string };

const props = Astro.props as {
  title?: string;
  description?: string;
  showFooter?: boolean;
  hasHero?: boolean;
  nav?: NavItem[];
};

const title = props.title ?? Astro.props.frontmatter?.title ?? "页面";
const description =
  props.description ?? "墨尔本·胜腾国际 - 房产投资 / 项目开发 / 租赁管理 / 移民服务";

const showFooter = props.showFooter ?? true;
const hasHero = props.hasHero ?? false;

const nav: NavItem[] =
  props.nav ??
  [
    { href: "/", label: "首页" },
    { href: "/real-estate", label: "房产资讯" },
    { href: "/property-service", label: "房产服务" },
    { href: "/loan", label: "贷款服务" },
    { href: "/immigration", label: "移民服务" },
    { href: "/company-profile", label: "公司概况" },
    { href: "/contact", label: "联系我们" },
  ];

const pathname = Astro.url?.pathname ?? "/";

function isActive(href: string) {
  if (href === "/") return pathname === "/";
  return pathname === href || pathname.startsWith(href + "/");
}

const saleCats = [
  { href: "/real-estate/sale/apartment", label: "公寓" },
  { href: "/real-estate/sale/second-hand", label: "二手房" },
  { href: "/real-estate/sale/townhouse", label: "联排别墅" },
  { href: "/real-estate/sale/land-villa", label: "土地别墅" },
  { href: "/real-estate/sale/commercial", label: "商业办公" },
  { href: "/real-estate/sale/land", label: "土地开发" },
  { href: "/real-estate/sale/farm", label: "农场" },
  { href: "/real-estate/sale/hotel", label: "酒店" },
];

const rentCats = [
  { href: "/real-estate/rent/apartment", label: "公寓" },
  { href: "/real-estate/rent/townhouse", label: "联排别墅" },
  { href: "/real-estate/rent/land-villa", label: "土地别墅" },
  { href: "/real-estate/rent/commercial", label: "商业办公" },
];

function isRealEstateActive() {
  return pathname === "/real-estate" || pathname.startsWith("/real-estate/");
}
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title} | Cendant</title>
    <meta name="description" content={description} />

    <!-- ===== template15 CSS ===== -->
    <link rel="stylesheet" href="/template15/css/bootstrap.css" />
    <link rel="stylesheet" href="/template15/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/template15/css/flexslider.css" />
    <link rel="stylesheet" href="/template15/css/owl.carousel.css" />
    <link rel="stylesheet" href="/template15/css/owl.theme.css" />
    <link rel="stylesheet" href="/template15/css/easy-responsive-tabs.css" />
    <link rel="stylesheet" href="/template15/css/style.css" />
    <link rel="stylesheet" href="/template15/css/mainStyles.css" />
    <!-- ===== 语言切换按钮（放在右上角，简单版） ===== -->
    <div id="lang-switch" style="position:fixed;right:14px;bottom:14px;z-index:99999;">
      <button id="btn-zh" class="btn btn-default btn-sm" type="button">中文</button>
      <button id="btn-en" class="btn btn-primary btn-sm" type="button">EN</button>
    </div>

    <script is:inline>
    (function () {
      var LANG_KEY = "site_lang";
      var lang = localStorage.getItem(LANG_KEY) || "zh";

      var btnZh = document.getElementById("btn-zh");
      var btnEn = document.getElementById("btn-en");

      function setLang(next) {
        localStorage.setItem(LANG_KEY, next);
        // 中文：直接刷新恢复原文
        if (next === "zh") { location.reload(); return; }
        // 英文：执行翻译
        translatePageToEnglish();
      }

      btnZh && btnZh.addEventListener("click", function(){ setLang("zh"); });
      btnEn && btnEn.addEventListener("click", function(){ setLang("en"); });

      // 初始化按钮样式
      function paint() {
        if (!btnZh || !btnEn) return;
        if (lang === "en") {
          btnEn.className = "btn btn-primary btn-sm";
          btnZh.className = "btn btn-default btn-sm";
        } else {
          btnZh.className = "btn btn-primary btn-sm";
          btnEn.className = "btn btn-default btn-sm";
        }
      }
      paint();

      // 如果用户之前选了 EN，自动翻译
      if (lang === "en") translatePageToEnglish();

      // ===== 核心：扫描文本节点并批量翻译 =====
      async function translatePageToEnglish() {
        paint();

        // 1) 收集可翻译文本（排除脚本/样式/输入框等）
        var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
        var nodes = [];
        var texts = [];
        var seen = new Map(); // 去重：同一句只翻译一次

        while (walker.nextNode()) {
          var n = walker.currentNode;
          if (!n || !n.nodeValue) continue;

          var t = n.nodeValue.trim();
          if (!t) continue;

          var p = n.parentElement;
          if (!p) continue;

          var tag = p.tagName;
          if (tag === "SCRIPT" || tag === "STYLE" || tag === "NOSCRIPT") continue;
          if (p.closest("script,style,noscript,textarea,input,select,option,code,pre")) continue;

          // 如果已经是英文/数字为主，就跳过（减少成本）
          if (/^[\x00-\x7F\s0-9.,:;!?'"()\-\+\/]+$/.test(t)) continue;

          // 去重
          if (!seen.has(t)) {
            seen.set(t, { idx: texts.length, trans: "" });
            texts.push(t);
          }
          nodes.push({ node: n, key: t });
        }

        if (!texts.length) return;

        // 2) 分批请求，避免一次太大
        async function batchTranslate(batch) {
          var res = await fetch("/api/translate.json", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ target: "en", texts: batch })
          });
          var json = await res.json();
          if (!res.ok) throw new Error(json && json.error ? json.error : "translate failed");
          return json.data || [];
        }

        // 3) 分批翻译 + 写回 map
        var BATCH = 60;
        for (var i = 0; i < texts.length; i += BATCH) {
          var part = texts.slice(i, i + BATCH);
          var out = await batchTranslate(part);
          for (var j = 0; j < part.length; j++) {
            var original = part[j];
            var translated = out[j] || "";
            if (seen.has(original)) seen.get(original).trans = translated;
          }
        }

        // 4) 替换页面文本
        for (var k = 0; k < nodes.length; k++) {
          var item = nodes[k];
          var info = seen.get(item.key);
          if (info && info.trans) {
            item.node.nodeValue = item.node.nodeValue.replace(item.key, decodeHtml(info.trans));
          }
        }
      }

      // Google 返回可能含有 HTML 实体（&amp; 等），解码一下
      function decodeHtml(s) {
        var d = document.createElement("textarea");
        d.innerHTML = s;
        return d.value;
      }
    })();
    </script>
    <style is:global>
      html, body { margin: 0; padding: 0; }
      html, body { visibility: visible !important; }
      body { display: block !important; }
      html:not([data-lang]) [data-lang] { display: revert !important; }

      body.tpl-body:not(.tpl-has-hero) { padding-top: var(--nav-h, 96px); }
      body.tpl-body.tpl-has-hero { padding-top: 0; }

      .banner#home { z-index: 9999; width: 100%; }

      body.tpl-body.tpl-has-hero .banner#home {
        position: absolute; left: 0; top: 0; background: transparent;
      }
      body.tpl-body:not(.tpl-has-hero) .banner#home {
        position: fixed; left: 0; top: 0; background: #fff;
      }

      .banner#home .navbar { margin: 0; border: none; padding: 10px 18px; background: transparent; }
      @media (max-width: 768px) { .banner#home .navbar { padding: 10px 12px; } }

      body.tpl-body:not(.tpl-has-hero) .banner#home .navbar {
        background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      }

      .navbar-header h1 { margin: 0 !important; padding: 0 !important; border: none !important; box-shadow: none !important; }
      a.navbar-brand.brand-with-logo, a.navbar-brand.brand-with-logo * { border: none !important; box-shadow: none !important; background: transparent !important; }
      a.navbar-brand.brand-with-logo::before, a.navbar-brand.brand-with-logo::after,
      .brand-badge::before, .brand-badge::after { content: none !important; }

      .brand-with-logo { display: flex !important; align-items: center !important; gap: 14px !important; padding: 6px 0 !important; }
      .brand-logo { height: 64px !important; width: auto !important; display: block !important; }
      @media (max-width: 768px) { .brand-logo { height: 44px !important; } }

      .brand-badge {
        display: inline-flex; flex-direction: column; line-height: 1.1;
        border: 2px solid rgba(255,255,255,0.8) !important;
        border-radius: 10px !important; padding: 6px 10px !important;
      }
      body.tpl-body:not(.tpl-has-hero) .brand-badge { border-color: rgba(9,26,93,0.35) !important; }

      .brand-main { font-size: 20px; font-weight: 800; white-space: nowrap; }
      .brand-sub { font-size: 11px; opacity: 0.75; letter-spacing: 2px; margin-top: 3px; white-space: nowrap; }
      @media (max-width: 768px) { .brand-main { font-size: 16px; } .brand-sub { font-size: 10px; letter-spacing: 1.5px; } }

      body.tpl-body.tpl-has-hero .navbar-default .navbar-brand,
      body.tpl-body.tpl-has-hero .navbar-default .navbar-brand span,
      body.tpl-body.tpl-has-hero .navbar-default .navbar-nav > li > a,
      body.tpl-body.tpl-has-hero .navbar-default .navbar-nav > li > a span { color: #fff !important; }

      body.tpl-body:not(.tpl-has-hero) .navbar-default .navbar-brand,
      body.tpl-body:not(.tpl-has-hero) .navbar-default .navbar-brand span,
      body.tpl-body:not(.tpl-has-hero) .navbar-default .navbar-nav > li > a,
      body.tpl-body:not(.tpl-has-hero) .navbar-default .navbar-nav > li > a span { color: #091a5d !important; }

      body.tpl-body.tpl-has-hero .navbar-default .navbar-toggle .icon-bar { background: #fff !important; }
      body.tpl-body:not(.tpl-has-hero) .navbar-default .navbar-toggle .icon-bar { background: #091a5d !important; }

      .navbar-nav > li.active > a span,
      .navbar-nav > li.active > a span:hover { font-weight: 800; }

      main.tpl-main { padding-top: 0; }

      /* dropdown 里不要被 link-effect-2 影响 */
      .navbar-nav li.dropdown .dropdown-menu a span { display: inline !important; }

      /* ✅ 二级 submenu：默认隐藏，JS 控制 */
      .dropdown-submenu { position: relative; }
      .dropdown-submenu > .dropdown-menu { display: none; padding: 6px 0; }

      @media (min-width: 768px) {
        .dropdown-submenu > .dropdown-menu {
          position: absolute; top: 0; left: 100%;
          margin-top: -6px; border-radius: 6px;
        }
      }
      @media (max-width: 768px) {
        .dropdown-submenu > .dropdown-menu { position: static; margin-left: 12px; margin-top: 6px; }
      }

      /* ✅ 让“文字”和“箭头”都可点开（不跳转） */
      .submenu-row{
        display:flex; align-items:center; justify-content:space-between;
        gap:10px; padding-right:6px;
      }
      .submenu-row a.submenu-toggle{
        flex:1;
        display:block;
        padding:10px 14px !important;
        cursor:pointer;
      }
      .submenu-row button.submenu-toggle-btn{
        width:34px; height:34px; border:none; background:transparent;
        cursor:pointer; border-radius:6px; line-height:34px; text-align:center; opacity:.85;
      }
      .submenu-row button.submenu-toggle-btn:hover{ background:rgba(0,0,0,.06); opacity:1; }
    </style>
  </head>

  <body class:list={["tpl-body", hasHero ? "tpl-has-hero" : ""]}>
    <div class="banner" id="home">
      <nav class="navbar navbar-default" id="site-navbar">
        <div class="navbar-header navbar-left">
          <button
            type="button"
            class="navbar-toggle collapsed"
            data-toggle="collapse"
            data-target="#bs-example-navbar-collapse-1"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>

          <h1>
            <a class="navbar-brand brand-with-logo" href="/">
              <img src="/images/logo.png" alt="Cendant Logo" class="brand-logo" />
              <span class="brand-badge">
                <span class="brand-main">墨尔本 · 胜腾国际</span>
                <span class="brand-sub">MELBOURNE · CENDANT</span>
              </span>
            </a>
          </h1>
        </div>

        <div class="collapse navbar-collapse navbar-right" id="bs-example-navbar-collapse-1">
          <nav class="link-effect-2" id="link-effect-2">
            <ul class="nav navbar-nav">
              {nav.map((i) => {
                if (i.href === "/real-estate") {
                  return (
                    <li class={`dropdown ${isRealEstateActive() ? "active" : ""}`} id="re-dd-root">
                      {/* ✅ 顶层只负责展开，不跳转（最稳） */}
                      <a
                        href="#"
                        class="dropdown-toggle"
                        data-toggle="dropdown"
                        role="button"
                        aria-haspopup="true"
                        aria-expanded="false"
                        data-re-root-toggle
                      >
                        <span data-hover="房产资讯">房产资讯</span> <span class="caret"></span>
                      </a>

                      <ul class="dropdown-menu tpl-re-dd">
                        {/* ✅ 新增：查看“房产资讯页面”的入口 */}
                        <li><a href="/real-estate">房产资讯主页</a></li>
                        <li role="separator" class="divider"></li>

                        {/* ✅ 售卖：文字=展开，箭头=展开（都不跳转） */}
                        <li class="dropdown-submenu" data-submenu="sale">
                          <div class="submenu-row">
                            <a
                              href="#"
                              class="submenu-toggle"
                              data-toggle-submenu="sale"
                              aria-label="展开售卖分类"
                            >房产售卖资讯</a>
                            <button
                              class="submenu-toggle-btn"
                              type="button"
                              aria-label="展开售卖分类"
                              data-toggle-submenu="sale"
                            >▸</button>
                          </div>

                          <ul class="dropdown-menu" data-submenu-panel="sale">
                            {saleCats.map((c) => (
                              <li><a href={c.href}>{c.label}</a></li>
                            ))}
                          </ul>
                        </li>

                        {/* ✅ 出租：文字=展开，箭头=展开（都不跳转） */}
                        <li class="dropdown-submenu" data-submenu="rent">
                          <div class="submenu-row">
                            <a
                              href="#"
                              class="submenu-toggle"
                              data-toggle-submenu="rent"
                              aria-label="展开出租分类"
                            >房产出租资讯</a>
                            <button
                              class="submenu-toggle-btn"
                              type="button"
                              aria-label="展开出租分类"
                              data-toggle-submenu="rent"
                            >▸</button>
                          </div>

                          <ul class="dropdown-menu" data-submenu-panel="rent">
                            {rentCats.map((c) => (
                              <li><a href={c.href}>{c.label}</a></li>
                            ))}
                          </ul>
                        </li>
                      </ul>
                    </li>
                  );
                }

                return (
                  <li class={isActive(i.href) ? "active" : ""}>
                    <a href={i.href}>
                      <span data-hover={i.label}>{i.label}</span>
                    </a>
                  </li>
                );
              })}
            </ul>
          </nav>
        </div>
      </nav>
    </div>

    <main class="tpl-main">
      <slot />
    </main>

    {showFooter && (
      <div class="footer">
        <div class="col-md-6 subscribe">
          <form action="#" method="post" onsubmit="return false;">
            <h3>联系我们</h3>
            <input type="text" name="Subscribe" placeholder="输入邮箱（可选）" />
            <a class="btn1" href="/contact">联系咨询</a>
          </form>
        </div>

        <div class="col-md-6 copyright">
          <ul>
            {nav.slice(0, 6).map((i) => (
              <li><a href={i.href}>{i.label}</a></li>
            ))}
          </ul>
          <p>© {new Date().getFullYear()} Melbourne Cendant. All rights reserved.</p>
        </div>

        <div class="clearfix"></div>
      </div>
    )}

    <!-- ✅ 子页不被遮挡：动态测量 navbar 高度 -->
    <script is:inline>
      (function () {
        function setNavHeight() {
          var nav = document.getElementById("site-navbar");
          if (!nav) return;
          var h = nav.getBoundingClientRect().height;
          document.body.style.setProperty("--nav-h", (h + 12) + "px");
        }
        window.addEventListener("load", setNavHeight);
        window.addEventListener("resize", setNavHeight);
        document.addEventListener("click", function () {
          setTimeout(setNavHeight, 50);
        });
      })();
    </script>

    <!-- ✅ 最关键：用 capture 阶段拦截，保证点击二级展开时 dropdown 不会被 Bootstrap 关闭 -->
    <script is:inline>
      (function () {
        function qs(sel, root) { return (root || document).querySelector(sel); }
        function qsa(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }

        function closeAll(exceptKey) {
          qsa("[data-submenu-panel]").forEach(function (panel) {
            var key = panel.getAttribute("data-submenu-panel");
            if (exceptKey && key === exceptKey) return;
            panel.style.display = "none";
          });
        }

        // 1) 顶层“房产资讯”是 #，必须阻止跳转（否则会出现不稳定跳页）
        document.addEventListener("click", function (e) {
          var root = e.target && e.target.closest && e.target.closest("[data-re-root-toggle]");
          if (!root) return;
          e.preventDefault();
        }, true);

        // 2) 任何点击发生在 dropdown-menu 内：阻止 Bootstrap 的“点一下就关闭”
        document.addEventListener("click", function (e) {
          var insideMenu = e.target && e.target.closest && e.target.closest(".tpl-re-dd");
          if (!insideMenu) return;
          e.stopPropagation();
        }, true);

        // 3) 点击“房产售卖/出租”（文字或箭头）= 只展开二级，并强制保持 dropdown open
        document.addEventListener("click", function (e) {
          var t = e.target && e.target.closest && e.target.closest("[data-toggle-submenu]");
          if (!t) return;

          e.preventDefault();
          e.stopPropagation();

          var key = t.getAttribute("data-toggle-submenu");
          if (!key) return;

          var panel = qs('[data-submenu-panel="' + key + '"]');
          if (!panel) return;

          var isOpen = panel.style.display === "block";
          closeAll(key);
          panel.style.display = isOpen ? "none" : "block";

          // ✅ 强制保持父 dropdown 处于打开状态（修复你说的“点一下就关”）
          var rootLi = t.closest && t.closest("li.dropdown");
          if (rootLi) {
            rootLi.classList.add("open");
            var toggle = qs("[data-re-root-toggle]", rootLi);
            if (toggle) toggle.setAttribute("aria-expanded", "true");
          }
        }, true);

        // 4) 点击 dropdown 外部：才关闭二级
        document.addEventListener("click", function (e) {
          var insideDropdown = e.target && e.target.closest && e.target.closest("#re-dd-root");
          if (insideDropdown) return;
          closeAll(null);
        }, true);
      })();
    </script>

    <!-- ===== template15 JS ===== -->
    <script is:inline src="/template15/js/jquery-2.1.4.min.js"></script>
    <script is:inline src="/template15/js/bootstrap.js"></script>
    <script is:inline src="/template15/js/numscroller-1.0.js"></script>
    <script is:inline src="/template15/js/owl.carousel.js"></script>
    <script is:inline src="/template15/js/jquery.flexslider.js"></script>
    <script is:inline src="/template15/js/easy-responsive-tabs.js"></script>
    <script is:inline src="/template15/js/SmoothScroll.min.js"></script>
    <script is:inline src="/template15/js/move-top.js"></script>
    <script is:inline src="/template15/js/easing.js"></script>
    <script is:inline src="/template15/js/mainScript.js"></script>
    <script is:inline src="/template15/js/rgbSlide.min.js"></script>
  </body>
</html>