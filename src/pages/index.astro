---
import TemplateLayout from "../layouts/TemplateLayout.astro";
import { getRealEstatePosts } from "../lib/contentful";

// 取最新发布（轮播用）
const posts = await getRealEstatePosts(8);

// 给每条文章找一张图：按你 Contentful 字段做容错
function pickImage(p) {
  // 你项目里常见的命名：coverImage / featuredImage / image
  const img =
    p.coverImage?.url ||
    p.featuredImage?.url ||
    p.image?.url ||
    p.heroImage?.url ||
    p.thumbnail?.url ||
    "";
  return img || "/template15/images/about.jpg"; // 没图就兜底
}
---

<TemplateLayout title="首页" hasHero={true}>
  <script is:inline>
    document.documentElement.classList.add("home-page");
    document.body && document.body.classList.add("home-page");
  </script>

  <!-- =======================
       你的 Slider（保持原样）
  ======================== -->
  <div class="home-hero">
    <div id="exampleSlider">
      <div>
        <h2>墨尔本 · 胜腾国际 <span>一站式房产与移民服务</span></h2>
        <div class="readmore-w3">
          <a class="readmore" href="/contact">立即咨询</a>
        </div>
      </div>

      <div>
        <h3>澳洲房产投资 <span>选房 · 评估 · 交易 · 管理</span></h3>
        <div class="readmore-w3">
          <a class="readmore" href="/real-estate">查看地产资讯</a>
        </div>
      </div>

      <div>
        <h3>移民服务支持 <span>雇主担保 · 商业投资</span></h3>
        <div class="readmore-w3">
          <a class="readmore" href="/immigration">查看移民服务</a>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       地产资讯（✅ 用 Contentful 最新内容 + ✅ 模板同款轮播视觉）
       说明：每张卡片直接链接到文章详情 /real-estate/{slug}
  ========================================================== -->
  <div class="special" id="offers">
    <h3 class="heading">
      <span>地产资讯</span>
    </h3>
    <p class="heading-en">PROPERTIES FOR SALE</p>

    <div class="container">
      <div class="agileits-special-grids">
        <div id="owl-demo" class="owl-carousel owl-theme">
          {posts && posts.length > 0 ? (
            posts.map((p) => (
              <div class="item">
                <a href={`/real-estate/${p.slug}`} style="text-decoration:none;">
                  <div
                    class="special-info re-prop-card"
                    style={`background-image:url('${pickImage(p)}')`}
                  >
                    <div class="re-prop-overlay">
                      <div class="re-prop-top">
                        <span class="re-prop-tag">{p.category ?? "资讯"}</span>
                      </div>

                      <h4 class="re-prop-title">{p.title}</h4>

                      {p.publishDate && (
                        <p class="re-prop-date">
                          {new Date(p.publishDate).toLocaleDateString("zh-CN")}
                        </p>
                      )}

                      <p class="re-prop-cta">查看详情 →</p>
                    </div>
                  </div>
                </a>
              </div>
            ))
          ) : (
            <div class="item">
              <div class="special-info re-prop-card" style="background:#0b1b54;">
                <div class="re-prop-overlay">
                  <h4 class="re-prop-title" style="color:#fff;">暂无内容</h4>
                  <p style="color:#fff;opacity:.9;">请先在 Contentful 发布 realEstatePost</p>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       联系我们（✅ 英文小标题 + ✅ 三列占满整行 + ✅ 不放图片）
  ========================================================== -->
  <div class="contact" id="contact">
    <h3 class="heading">
      <span>联系我们</span>
    </h3>
    <p class="heading-en heading-en-light">CONTACT US</p>

    <div class="container">
      <div class="row re-contact-row">
        <div class="col-md-4 col-sm-12 mail re-contact-col">
          <h4>联系方式</h4>
          <p><span class="glyphicon glyphicon-phone"></span> +61 420 616 883</p>
          <p>
            <span class="glyphicon glyphicon-envelope"></span>
            <a href="mailto:info@cendantpgau.com">info@cendantpgau.com</a>
          </p>
        </div>

        <div class="col-md-4 col-sm-12 address re-contact-col">
          <h4>地址</h4>
          <p><span class="glyphicon glyphicon-map-marker"></span> 2 Aquitania Way, Docklands VIC 3008</p>
        </div>

        <div class="col-md-4 col-sm-12 social re-contact-col">
          <h4>快速入口</h4>
          <ul>
            <li><a href="/company-profile"><i class="fa fa-info"></i></a></li>
            <li><a href="/real-estate"><i class="fa fa-building"></i></a></li>
            <li><a href="/immigration"><i class="fa fa-plane"></i></a></li>
            <li><a href="/contact"><i class="fa fa-phone"></i></a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>
  </div>

  <!-- 你原来的 contact-form / 其他模块保持不动即可 -->

  <!-- ✅ 关键：强制初始化 Owl（避免“部署后不动/不显示”） -->
  <script is:inline>
    (function () {
      function initOwl() {
        if (!window.jQuery) return;
        const $ = window.jQuery;
        const $owl = $("#owl-demo");

        // 避免重复初始化
        if (!$owl.length || $owl.hasClass("owl-loaded")) return;

        $owl.owlCarousel({
          items: 3,
          itemsDesktop: [1199, 3],
          itemsDesktopSmall: [979, 2],
          itemsTablet: [768, 2],
          itemsMobile: [479, 1],
          autoPlay: true,
          navigation: true,
          pagination: true,
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initOwl);
      } else {
        initOwl();
      }

      // 防止某些模板脚本延迟加载导致第一次 init 失败
      setTimeout(initOwl, 800);
    })();
  </script>

  <style is:global>
    /* 首屏贴顶兜底 */
    .home-hero, #exampleSlider { margin-top: 0 !important; padding-top: 0 !important; }

    /* ===== 通用：模板 heading 下的英文小标题（强制显示） ===== */
    .heading-en{
      text-align:center !important;
      margin: -10px 0 25px !important;
      font-size: 12px !important;
      letter-spacing: 3px !important;
      text-transform: uppercase !important;
      color: #0b1b54 !important;
      font-weight: 700 !important;
      opacity: .95 !important;
      display:block !important;
    }
    .heading-en-light{
      color:#fff !important;
      opacity: .9 !important;
    }

    /* ===== 联系我们：确保三列真的“占满整行” ===== */
    .re-contact-row{ margin-top: 10px; }
    .re-contact-col{ margin-bottom: 10px; }
    @media (min-width: 992px){
      .re-contact-col{ min-height: 160px; }
    }

    /* ===== 地产资讯：做成“模板 Properties for Sale 那种卡片背景图” ===== */
    .re-prop-card{
      border-radius: 10px;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      min-height: 260px;
      position: relative;
      border: 1px solid rgba(0,0,0,.06);
    }

    .re-prop-overlay{
      position:absolute;
      left:0; right:0; bottom:0;
      padding: 18px 18px 16px;
      background: linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,.15));
    }

    .re-prop-tag{
      display:inline-block;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      background: rgba(11,27,84,.72);
      padding: 4px 10px;
      border-radius: 999px;
      margin-bottom: 10px;
    }

    .re-prop-title{
      margin: 0;
      font-size: 16px;
      font-weight: 800;
      color: #fff;
      line-height: 1.35;
    }

    .re-prop-date{
      margin: 6px 0 0;
      font-size: 12px;
      color: rgba(255,255,255,.85);
    }

    .re-prop-cta{
      margin: 10px 0 0;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      font-weight: 700;
      letter-spacing: .5px;
    }

    /* 让 hover 更像模板 */
    .re-prop-card:hover{
      transform: translateY(-3px);
      transition: all .25s ease;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
  </style>
</TemplateLayout>