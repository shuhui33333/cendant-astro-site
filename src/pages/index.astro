---
import TemplateLayout from "../layouts/TemplateLayout.astro";
import { getRealEstatePosts } from "../lib/contentful";

/**
 * ✅ Cloudflare Pages (Astro SSR) 正确读取环境变量：
 * - 运行时：Astro.locals.runtime.env
 * - 本地 dev：import.meta.env（兜底）
 */
const runtimeEnv = (Astro.locals as any)?.runtime?.env ?? {};
const buildEnv = (import.meta as any)?.env ?? {};

// 合并：运行时优先，其次本地 dev 兜底
const env = {
  ...buildEnv,
  ...runtimeEnv,
};

// ✅ 传 env 进去
const posts = await getRealEstatePosts(env, 9);

/** ✅ 统一获取封面（优先 p.image，其次 p.imageUrls[0]，都没有就用占位图） */
function pickImage(p: any) {
  const u =
    p?.image ||
    (Array.isArray(p?.imageUrls) ? p.imageUrls[0] : "") ||
    "";

  if (!u) return "/template15/images/banner.jpg"; // ✅ 兜底占位
  return String(u).startsWith("//") ? `https:${u}` : String(u);
}

/** ✅ 类别显示：如果 Contentful 里是 slug，就映射成中文；如果本来是中文就直接显示 */
const categoryMap: Record<string, string> = {
  apartment: "公寓",
  "second-hand": "二手房",
  townhouse: "联排别墅",
  "land-villa": "土地别墅",
  commercial: "商业办公",
  land: "土地开发",
  farm: "农场",
  hotel: "酒店",
};
function displayCategory(v: any) {
  const s = String(v ?? "").trim();
  return categoryMap[s] ?? (s || "资讯");
}
---

<TemplateLayout title="首页" hasHero={true} showFooter={true}>
  <!-- slider -->
  <div class="home-hero">
    <div id="exampleSlider">
      <div>
        <h2>墨尔本 · 胜腾国际 <span>一站式房产与移民服务</span></h2>
        <div class="readmore-w3">
          <a class="readmore" href="/contact">立即咨询</a>
        </div>
      </div>

      <div>
        <h3>澳洲房产投资 <span>选房 · 评估 · 交易 · 管理</span></h3>
        <div class="readmore-w3">
          <a class="readmore" href="/real-estate">查看地产资讯</a>
        </div>
      </div>

      <div>
        <h3>移民服务支持 <span>雇主担保 · 商业投资</span></h3>
        <div class="readmore-w3">
          <a class="readmore" href="/immigration">查看移民服务</a>
        </div>
      </div>
    </div>
  </div>

  <!-- 公司概况 -->
  <div class="about" id="about">
    <h3 class="heading"><span>公司概况</span></h3>

    <div class="container">
      <div class="services-grids">
        <div class="col-md-4 services-grids-info sgi">
          <h3>墨尔本·胜腾国际</h3>
          <p>
            专注澳洲房地产投资与资产配置，提供项目推荐、开发管理、租赁管理及移民咨询等综合服务。
          </p>
          <ul>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/real-estate">房产买卖与房产租赁</a></li>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/property-service">豪宅定制与过户法务</a></li>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/loan">贷款服务与换汇业务</a></li>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/immigration">澳洲移民咨询服务</a></li>
          </ul>
        </div>

        <div class="col-md-4 services-grids-info">
          <img src="/template15/images/about.jpg" alt="about" />
        </div>

        <div class="col-md-4 services-grids-info sgi1">
          <h3>高端投资服务</h3>
          <p>
            以专业研究与风控为基础，结合本地资源与项目对接能力，为投资者提供更稳健的资产配置路径。
          </p>
          <ul>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/company-profile">本地资源与合作网络</a></li>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/company-profile">合规流程与风险控制</a></li>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/property-service">市场分析与选房策略</a></li>
            <li><i class="glyphicon glyphicon-arrow-right"> </i><a href="/contact">预约咨询与项目对接</a></li>
          </ul>
        </div>

        <div class="clearfix"> </div>
      </div>
    </div>
  </div>

  <!-- 服务项目 -->
  <div class="services" id="services">
    <h3 class="heading"><span>服务项目</span></h3>

    <div class="container">
      <div class="col-md-8 servicesleft">
        <h4>为澳洲房产投资与移民规划提供一站式支持</h4>
        <h4>专业 · 合规 · 高效</h4>

        <div class="serviceslefttop">
          <div class="col-md-4">
            <a href="/real-estate" style="text-decoration:none;">
              <div class="grid1 clr1">
                <i class="fa fa-home" aria-hidden="true"></i>
                <h4>房产资讯</h4>
                <h4>- Cendant</h4>
              </div>
            </a>
          </div>

          <div class="col-md-4">
            <a href="/property-service" style="text-decoration:none;">
              <div class="grid1 clr2">
                <i class="fa fa-building" aria-hidden="true"></i>
                <h4>房产服务</h4>
                <h4>- Cendant</h4>
              </div>
            </a>
          </div>

          <div class="col-md-4">
            <a href="/loan" style="text-decoration:none;">
              <div class="grid1 clr3">
                <i class="fa fa-money" aria-hidden="true"></i>
                <h4>贷款服务</h4>
                <h4>- Cendant</h4>
              </div>
            </a>
          </div>

          <div class="clearfix"></div>
        </div>

        <div class="servicesleftbottom">
          <div class="col-md-4">
            <a href="/immigration" style="text-decoration:none;">
              <div class="grid1 clr4">
                <i class="fa fa-key" aria-hidden="true"></i>
                <h4>移民服务</h4>
                <h4>- Cendant</h4>
              </div>
            </a>
          </div>

          <div class="col-md-4">
            <a href="/company-profile" style="text-decoration:none;">
              <div class="grid1 clr5">
                <i class="fa fa-plane" aria-hidden="true"></i>
                <h4>公司概况</h4>
                <h4>- Cendant</h4>
              </div>
            </a>
          </div>

          <div class="col-md-4">
            <a href="/contact" style="text-decoration:none;">
              <div class="grid1 clr6">
                <i class="fa fa-phone" aria-hidden="true"></i>
                <h4>预约咨询</h4>
                <h4>- Cendant</h4>
              </div>
            </a>
          </div>

          <div class="clearfix"></div>
        </div>
      </div>

      <div class="clearfix"></div>
    </div>
  </div>

  <!-- 数据概览 -->
  <div class="count-agileits" id="stats">
    <h3 class="heading"><span>数据概览</span></h3>

    <div class="container">
      <div class="count-grids">
        <div class="count-bgcolor-w3ls">
          <div class="col-md-3 count-grid">
            <div class="count hvr-bounce-to-bottom">
              <div class="numscroller numscroller-big-bottom" data-slno="1" data-min="0" data-max="15" data-delay=".5" data-increment="1">15</div>
              <span></span>
              <h5>行业经验（年）</h5>
            </div>
          </div>

          <div class="col-md-3 count-grid">
            <div class="count hvr-bounce-to-bottom">
              <div class="numscroller numscroller-big-bottom" data-slno="1" data-min="0" data-max="205" data-delay=".5" data-increment="1">205</div>
              <span></span>
              <h5>项目对接</h5>
            </div>
          </div>

          <div class="col-md-3 count-grid">
            <div class="count hvr-bounce-to-bottom">
              <div class="numscroller numscroller-big-bottom" data-slno="1" data-min="0" data-max="38" data-delay=".5" data-increment="1">38</div>
              <span></span>
              <h5>合作资源</h5>
            </div>
          </div>

          <div class="col-md-3 count-grid">
            <div class="count hvr-bounce-to-bottom">
              <div class="numscroller numscroller-big-bottom" data-slno="1" data-min="0" data-max="557" data-delay=".5" data-increment="1">557</div>
              <h5>咨询响应</h5>
            </div>
          </div>

          <div class="clearfix"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ 地产资讯：用 owl-carousel 图片滚动（来自 Contentful 真实图片） -->
  <div class="special" id="offers">
    <h3 class="heading"><span>地产资讯</span></h3>

    <div class="container">
      <div class="agileits-special-grids">
        <div id="owl-demo" class="owl-carousel owl-theme">
          {posts && posts.length > 0 ? (
            posts.map((p: any) => (
              <div class="item">
                <a href={`/real-estate/${p.slug}`} style="text-decoration:none;">
                  <div
                    class="re-prop-card"
                    style={`background-image:url('${pickImage(p)}')`}
                  >
                    <div class="re-prop-overlay">
                      <span class="re-prop-tag">{displayCategory(p.category)}</span>
                      <h4 class="re-prop-title">{p.title}</h4>
                      {p.publishDate && (
                        <p class="re-prop-date">
                          {new Date(p.publishDate).toLocaleDateString("zh-CN")}
                        </p>
                      )}
                    </div>
                  </div>
                </a>
              </div>
            ))
          ) : (
            <div class="item">
              <div class="re-prop-card" style="background:#0b1b54;">
                <div class="re-prop-overlay">
                  <h4 class="re-prop-title" style="color:#fff;">暂无内容</h4>
                  <p class="re-prop-date" style="color:#fff;opacity:.9;">请在 Contentful 发布 realEstatePost</p>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- 联系我们 -->
  <div class="contact" id="contact">
    <h3 class="heading"><span>联系我们</span></h3>
    <p class="heading-en heading-en-on-dark">CONTACT US</p>

    <div class="container">
      <div class="row">
        <div class="col-md-4 col-sm-12 mail">
          <h4>联系方式</h4>
          <p><span class="glyphicon glyphicon-phone"></span> +61 420 616 883</p>
          <p>
            <span class="glyphicon glyphicon-envelope"></span>
            <a href="mailto:info@cendantpgau.com">info@cendantpgau.com</a>
          </p>
        </div>

        <div class="col-md-4 col-sm-12 address">
          <h4>地址</h4>
          <p><span class="glyphicon glyphicon-map-marker"></span> 2 Aquitania Way, Docklands VIC 3008</p>
        </div>

        <div class="col-md-4 col-sm-12 social">
          <h4>快速入口</h4>
          <ul>
            <li><a href="/company-profile"><i class="fa fa-info"></i></a></li>
            <li><a href="/real-estate"><i class="fa fa-building"></i></a></li>
            <li><a href="/immigration"><i class="fa fa-plane"></i></a></li>
            <li><a href="/contact"><i class="fa fa-phone"></i></a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>
  </div>

  <!-- 留言表单 -->
  <div class="contact-form">
    <h3 class="heading"><span>在线留言</span></h3>
    <div class="container">
      <form id="lead-form">
        <input name="name" type="text" placeholder="姓名" required />
        <input name="email" type="email" placeholder="邮箱" required />
        <input name="phone" type="text" placeholder="电话" />
        <textarea name="message" placeholder="留言内容" required></textarea>
        <button class="btn1" type="submit">提交</button>
        <p id="lead-result" style="margin-top:10px;"></p>
      </form>
    </div>
  </div>

  <!-- 初始化 Owl（只初始化 #owl-demo，避免影响其他模块） -->
  <script is:inline>
    (function () {
      function initOwl() {
        if (!window.jQuery) return;
        var $ = window.jQuery;
        var $owl = $("#owl-demo");
        if (!$owl.length || $owl.hasClass("owl-loaded")) return;

        $owl.owlCarousel({
          items: 3,
          itemsDesktop: [1199, 3],
          itemsDesktopSmall: [979, 2],
          itemsTablet: [768, 2],
          itemsMobile: [479, 1],
          autoPlay: true,
          navigation: true,
          pagination: true,
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initOwl);
      } else {
        initOwl();
      }
      setTimeout(initOwl, 800);
    })();
  </script>

  <!-- 留言提交 -->
  <script is:inline>
    (function () {
      var form = document.getElementById("lead-form");
      var result = document.getElementById("lead-result");
      if (!form || !result) return;

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        result.textContent = "提交中…";

        var data = Object.fromEntries(new FormData(form));
        data.topic = "首页咨询";

        try {
          var res = await fetch("/api/leads", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (res.ok) {
            result.textContent = "我们已收到您的信息，会尽快联系您。";
            form.reset();
          } else {
            result.textContent = "提交失败，请稍后再试。";
          }
        } catch (err) {
          result.textContent = "网络异常，请稍后再试。";
        }
      });
    })();
  </script>

  <style is:global>
    .home-hero,
    #exampleSlider { margin-top: 0 !important; padding-top: 0 !important; }

    .heading-en{
      display:block !important;
      text-align:center !important;
      margin:-12px 0 26px !important;
      font-size:12px !important;
      letter-spacing:3px !important;
      text-transform:uppercase !important;
      font-weight:700 !important;
      opacity:.9 !important;
      line-height:1.4 !important;
      color:#0b1b54 !important;
    }
    .heading-en-on-dark{ color:#fff !important; }

    .re-prop-card{
      border-radius:10px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
      min-height:260px;
      position:relative;
      border:1px solid rgba(0,0,0,.06);
    }
    .re-prop-overlay{
      position:absolute; left:0; right:0; bottom:0;
      padding:18px 18px 16px;
      background:linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,.12));
    }
    .re-prop-tag{
      display:inline-block;
      font-size:12px;
      color:rgba(255,255,255,.92);
      background:rgba(11,27,84,.72);
      padding:4px 10px;
      border-radius:999px;
      margin-bottom:10px;
    }
    .re-prop-title{
      margin:0;
      font-size:16px;
      font-weight:800;
      color:#fff;
      line-height:1.35;
    }
    .re-prop-date{
      margin:6px 0 0;
      font-size:12px;
      color:rgba(255,255,255,.85);
    }
  </style>
</TemplateLayout>