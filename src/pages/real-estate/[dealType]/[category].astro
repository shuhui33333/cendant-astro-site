---
import TemplateLayout from "../../../layouts/TemplateLayout.astro";
import { getRealEstatePosts } from "../../../lib/contentful";

export const prerender = true;

/** ===== 中英文兼容：把任意字符串清理一下 ===== */
function normalizeText(s: string) {
  return String(s ?? "").trim();
}

/** ===== Category 映射：URL slug -> 中文 ===== */
const categoryNameMap: Record<string, string> = {
  apartment: "公寓",
  "second-hand": "二手房",
  townhouse: "联排别墅",
  "land-villa": "土地别墅",
  commercial: "商业办公",
  land: "土地开发",
  farm: "农场",
  hotel: "酒店",
};

/** ===== 反向映射：中文 -> slug ===== */
const categoryZhToSlug: Record<string, string> = Object.fromEntries(
  Object.entries(categoryNameMap).map(([slug, zh]) => [zh, slug])
);

/** 把任意 category（中文/英文）都归一成 slug，用于比较 */
function normalizeCategoryToSlug(input: string) {
  const raw = normalizeText(input);

  // 1) 直接中文命中
  if (categoryZhToSlug[raw]) return categoryZhToSlug[raw];

  // 2) 常见中文别名兜底
  const alias: Record<string, string> = {
    "商业办公楼": "commercial",
    "商业办公": "commercial",
    "土地别墅": "land-villa",
    "联排别墅": "townhouse",
    "二手房": "second-hand",
    "土地开发": "land",
    "公寓": "apartment",
    "农场": "farm",
    "酒店": "hotel",
  };
  if (alias[raw]) return alias[raw];

  // 3) 英文 slug 化兜底
  return raw
    .toLowerCase()
    .replace(/&/g, "and")
    .replace(/[\s_]+/g, "-")
    .replace(/[^\w-]+/g, "")
    .replace(/-+/g, "-");
}

/** dealType 也支持中文：出售/售卖/出租/租赁 */
function normalizeDealType(input: string) {
  const raw = normalizeText(input).toLowerCase();

  // 中文判断
  if (raw.includes("售") || raw.includes("卖") || raw.includes("出")) return "sale";
  if (raw.includes("租")) return "rent";

  // 英文判断
  if (raw === "sale") return "sale";
  if (raw === "rent") return "rent";

  return raw;
}

function labelDealType(d: string) {
  return normalizeDealType(d) === "sale" ? "房产售卖资讯" : "房产出租资讯";
}

/** ✅ 关键修复：把所有路径数组放到 getStaticPaths 里面，避免 saleCats not defined */
export async function getStaticPaths() {
  const saleCats = [
    "apartment",
    "second-hand",
    "townhouse",
    "land-villa",
    "commercial",
    "land",
    "farm",
    "hotel",
  ];

  const rentCats = ["apartment", "townhouse", "land-villa", "commercial"];

  const paths: { params: { dealType: string; category: string } }[] = [];

  for (const c of saleCats) paths.push({ params: { dealType: "sale", category: c } });
  for (const c of rentCats) paths.push({ params: { dealType: "rent", category: c } });

  return paths;
}

const { dealType, category } = Astro.params as { dealType: string; category: string };

const dealSlug = normalizeDealType(dealType);
const categorySlug = normalizeCategoryToSlug(category);

const dealZh = labelDealType(dealSlug);
const categoryZh = categoryNameMap[categorySlug] ?? category;

/** 拉取内容（你文章多就把 200 调大） */
const allPosts = await getRealEstatePosts(200);

/** ✅ 过滤：中英文都能匹配 */
const posts =
  allPosts?.filter((p) => {
    const pDeal = normalizeDealType(p.dealType ?? "");
    const pCatSlug = normalizeCategoryToSlug(p.category ?? "");
    return pDeal === dealSlug && pCatSlug === categorySlug;
  }) ?? [];
---

<TemplateLayout title={`${dealZh} - ${categoryZh}`} subtitle="REAL ESTATE">
  <section class="section-padding">
    <div class="container">
      <div class="section-title re-title">
        <h2>{dealZh} · {categoryZh}</h2>
      </div>

      {posts.length ? (
        <div class="blog-grid">
          {posts.map((p) => (
            <a class="blog-card" href={`/real-estate/${p.slug}`}>
              <div class="blog-content">
                <span class="blog-tag">{p.category ?? "资讯"}</span>
                <h4>{p.title}</h4>
                {p.publishDate && (
                  <p class="blog-date">
                    {new Date(p.publishDate).toLocaleDateString("zh-CN")}
                  </p>
                )}
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="empty">
          <p><strong>当前分类暂无内容</strong></p>
          <p style="margin-top:8px;">
            请在 Contentful 发布文章，并确保：
            <code>dealType</code> 为 <code>sale/rent</code> 或中文（如“出售/出租”），
            <code>category</code> 可填中文（如“公寓”）或英文 slug（如 <code>{categorySlug}</code>）。
          </p>
        </div>
      )}
    </div>
  </section>
</TemplateLayout>

<style>
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 22px;
  }
  .blog-card {
    display: block;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.06);
    text-decoration: none;
    transition: all .25s ease;
  }
  .blog-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 26px rgba(0,0,0,.08);
  }
  .blog-tag {
    font-size: 12px;
    color: #5b6474;
    display: inline-block;
    margin-bottom: 8px;
  }
  .blog-card h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 800;
    line-height: 1.35;
    color: #0b1b54;
  }
  .blog-date {
    font-size: 12px;
    color: #8a93a3;
    margin-top: 8px;
  }
  .empty {
    padding: 34px;
    text-align: center;
    background: #fff;
    border-radius: 12px;
    border: 1px dashed rgba(11,27,84,.25);
  }
</style>