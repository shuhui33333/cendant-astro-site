---
import TemplateLayout from "../../../layouts/TemplateLayout.astro";
import { getRealEstatePosts } from "../../../lib/contentful";

// URL 参数：/real-estate/:dealType/:category
const { dealType, category } = Astro.params as {
  dealType: string;
  category: string;
};

// 允许的值（避免用户乱输入导致页面报错/SEO重复）
const DEALS = ["sale", "rent"] as const;
const CATEGORIES = [
  "apartment",
  "second-hand",
  "townhouse",
  "land-villa",
  "commercial",
  "land",
  "farm",
  "hotel",
] as const;

const dealOk = (DEALS as readonly string[]).includes(dealType);
const catOk = (CATEGORIES as readonly string[]).includes(category);

if (!dealOk || !catOk) {
  // 不合法就返回 404（Astro 推荐抛出 Response）
  throw new Response("Not found", { status: 404 });
}

// 友好显示名
const dealZh = dealType === "sale" ? "售卖" : "出租";

const categoryZhMap: Record<string, string> = {
  apartment: "公寓",
  "second-hand": "二手房",
  townhouse: "联排别墅",
  "land-villa": "土地别墅",
  commercial: "商业办公",
  land: "土地开发",
  farm: "农场",
  hotel: "酒店",
};

const pageTitle = `${categoryZhMap[category] ?? category} · ${dealZh}`;

// 拉全部，再前端过滤（你现在的 contentful.ts 大概率就是这种取法）
const allPosts = await getRealEstatePosts(200);

// 兼容：有些人可能在 Contentful 填了 Sale / Rent 或中文
function normalizeDeal(v: any) {
  const s = String(v ?? "").trim().toLowerCase();
  if (s === "sale" || s === "出售") return "sale";
  if (s === "rent" || s === "出租") return "rent";
  return s;
}

function normalizeCat(v: any) {
  return String(v ?? "").trim().toLowerCase();
}

const posts = (allPosts ?? []).filter((p: any) => {
  return normalizeDeal(p.dealType) === dealType && normalizeCat(p.category) === category;
});
---

<TemplateLayout title={pageTitle} subtitle="REAL ESTATE">
  <section class="section-padding">
    <div class="container">
      <div class="re-head">
        <h2 class="re-title">{pageTitle}</h2>
        <p class="re-sub">
          {dealType === "sale"
            ? "精选售卖资讯与成交参考，助您更稳健做出决策。"
            : "出租资讯与租赁管理建议，帮助您提升出租效率与回报。"}
        </p>
      </div>

      {posts.length > 0 ? (
        <div class="re-grid">
          {posts.map((p: any) => (
            <a class="re-card" href={`/real-estate/${p.slug}`}>
              <div class="re-card__top">
                <span class="re-tag">{p.category ?? "资讯"}</span>
                {p.publishDate ? (
                  <span class="re-date">
                    {new Date(p.publishDate).toLocaleDateString("zh-CN")}
                  </span>
                ) : null}
              </div>
              <h3 class="re-card__title">{p.title}</h3>
              <p class="re-card__cta">查看详情 →</p>
            </a>
          ))}
        </div>
      ) : (
        <div class="re-empty">
          <p><strong>暂无内容</strong></p>
          <p>请在 Contentful 创建并发布对应分类的内容。</p>
          <p class="re-empty__hint">
            需要满足：dealType = <code>{dealType}</code>，category = <code>{category}</code>
          </p>
        </div>
      )}
    </div>
  </section>

  <style>
    .re-head { margin-bottom: 22px; }
    .re-title {
      margin: 0;
      font-size: 24px;
      font-weight: 900;
      color: #0b1b54;
      letter-spacing: .5px;
    }
    .re-sub {
      margin: 10px 0 0;
      color: #5b6474;
      font-size: 14px;
      line-height: 1.8;
    }

    .re-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 18px;
    }
    .re-card{
      display:block;
      padding: 18px 18px 16px;
      border: 1px solid rgba(11,27,84,.10);
      border-radius: 14px;
      background:#fff;
      text-decoration:none;
      transition: all .25s ease;
    }
    .re-card:hover{
      transform: translateY(-3px);
      box-shadow: 0 10px 26px rgba(0,0,0,.08);
      border-color: rgba(11,27,84,.18);
    }
    .re-card__top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .re-tag{
      font-size: 12px;
      color:#0b1b54;
      background: rgba(242,162,58,.15);
      border-radius: 999px;
      padding: 4px 10px;
      font-weight: 700;
    }
    .re-date{
      font-size: 12px;
      color:#8a93a3;
    }
    .re-card__title{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      color:#0b1b54;
      line-height: 1.45;
    }
    .re-card__cta{
      margin: 10px 0 0;
      font-size: 13px;
      color:#0b1b54;
      opacity:.9;
      font-weight: 700;
    }

    .re-empty{
      padding: 28px;
      border: 1px dashed rgba(11,27,84,.25);
      border-radius: 14px;
      background: #fff;
      text-align:center;
    }
    .re-empty__hint{
      margin-top: 10px;
      color:#6b7280;
      font-size: 13px;
    }
    code{ background: rgba(0,0,0,.06); padding: 2px 6px; border-radius: 6px; }
  </style>
</TemplateLayout>