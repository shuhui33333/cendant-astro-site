---
import TemplateLayout from "../../../layouts/TemplateLayout.astro";
import { getRealEstatePosts } from "../../../lib/contentful";

export const prerender = true;

/** ✅ 你的 URL 分类（要和你首页链接一致） */
const saleCats = [
  "apartment",
  "second-hand",
  "townhouse",
  "land-villa",
  "commercial",
  "land",
  "farm",
  "hotel",
];

const rentCats = [
  "apartment",
  "townhouse",
  "land-villa",
  "commercial",
];

const dealTypes = ["sale", "rent"] as const;

function labelDealType(d: string) {
  return d === "sale" ? "房产售卖资讯" : "房产出租资讯";
}

const categoryNameMap: Record<string, string> = {
  apartment: "公寓",
  "second-hand": "二手房",
  townhouse: "联排别墅",
  "land-villa": "土地别墅",
  commercial: "商业办公",
  land: "土地开发",
  farm: "农场",
  hotel: "酒店",
};

/** 把 Contentful 里的 category 文本转成和 URL 一样的 slug（更稳） */
function normalizeToSlug(s: string) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/&/g, "and")
    .replace(/[\s_]+/g, "-")
    .replace(/[^\w-]+/g, "")
    .replace(/-+/g, "-");
}

export async function getStaticPaths() {
  const paths: { params: { dealType: string; category: string } }[] = [];

  // sale
  for (const c of saleCats) {
    paths.push({ params: { dealType: "sale", category: c } });
  }
  // rent
  for (const c of rentCats) {
    paths.push({ params: { dealType: "rent", category: c } });
  }

  return paths;
}

const { dealType, category } = Astro.params as {
  dealType: string;
  category: string;
};

const dealZh = labelDealType(dealType);
const categoryZh = categoryNameMap[category] ?? category;

/** ✅ 拉内容（如果你文章很多，可以把 200 改大一些） */
const allPosts = await getRealEstatePosts(200);

/**
 * ✅ 过滤规则：
 * 1) dealType 字段匹配（sale/rent）
 * 2) category 字段匹配（允许 Contentful 存中文/英文，都会尽量转成 slug 比较）
 */
const posts =
  allPosts?.filter((p) => {
    const pDeal = normalizeToSlug(p.dealType ?? "");
    const pCat = normalizeToSlug(p.category ?? "");
    return pDeal === normalizeToSlug(dealType) && pCat === normalizeToSlug(category);
  }) ?? [];
---

<TemplateLayout title={`${dealZh} - ${categoryZh}`} subtitle="REAL ESTATE">
  <section class="section-padding">
    <div class="container">
      <div class="section-title re-title">
        <h2>{dealZh} · {categoryZh}</h2>
      </div>

      {posts.length ? (
        <div class="blog-grid">
          {posts.map((p) => (
            <a class="blog-card" href={`/real-estate/${p.slug}`}>
              <div class="blog-content">
                <span class="blog-tag">{p.category ?? "资讯"}</span>
                <h4>{p.title}</h4>
                {p.publishDate && (
                  <p class="blog-date">
                    {new Date(p.publishDate).toLocaleDateString("zh-CN")}
                  </p>
                )}
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="empty">
          <p><strong>当前分类暂无内容</strong></p>
          <p>
            请在 Contentful 发布对应文章，并确保字段：
            <code>dealType</code> = <code>{dealType}</code>，
            <code>category</code> = <code>{category}</code>
          </p>
        </div>
      )}
    </div>
  </section>
</TemplateLayout>

<style>
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 22px;
  }
  .blog-card {
    display: block;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.06);
    text-decoration: none;
    transition: all .25s ease;
  }
  .blog-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 26px rgba(0,0,0,.08);
  }
  .blog-tag {
    font-size: 12px;
    color: #5b6474;
    display: inline-block;
    margin-bottom: 8px;
  }
  .blog-card h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 800;
    line-height: 1.35;
    color: #0b1b54;
  }
  .blog-date {
    font-size: 12px;
    color: #8a93a3;
    margin-top: 8px;
  }
  .empty {
    padding: 34px;
    text-align: center;
    background: #fff;
    border-radius: 12px;
    border: 1px dashed rgba(11,27,84,.25);
  }
</style>