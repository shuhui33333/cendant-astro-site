---
import TemplateLayout from "../../layouts/TemplateLayout.astro";
import { getRealEstatePostBySlug } from "../../lib/contentful";

export const prerender = false;

/**
 * ✅ Cloudflare Pages runtime env + 本地 dev 兜底
 * 尽可能兼容不同 adapter/版本的注入路径：
 * - Astro.locals.runtime.env
 * - Astro.locals.cloudflare.env
 * - Astro.locals.env
 */
function getCfEnv() {
  const runtimeEnv =
    (Astro.locals as any)?.runtime?.env ??
    (Astro.locals as any)?.cloudflare?.env ??
    (Astro.locals as any)?.env ??
    {};

  // 本地开发/构建时可能存在 import.meta.env（但注意：真正的 secret 还是要走 runtime env）
  const buildEnv = (import.meta as any)?.env ?? {};

  // SSR：runtime 覆盖 build
  const merged = { ...buildEnv, ...runtimeEnv };

  return {
    CONTENTFUL_SPACE_ID: merged.CONTENTFUL_SPACE_ID,
    CONTENTFUL_DELIVERY_TOKEN: merged.CONTENTFUL_DELIVERY_TOKEN,
    CONTENTFUL_ENVIRONMENT: merged.CONTENTFUL_ENVIRONMENT ?? "master",
  };
}

const { slug } = Astro.params as { slug?: string };
const cfEnv = getCfEnv();

// ✅ 关键：打印 env + slug，去 Cloudflare Log Explorer 看就知道为什么 404
console.log("[real-estate/[slug]] env check", {
  slug,
  hasSpace: !!cfEnv.CONTENTFUL_SPACE_ID,
  hasToken: !!cfEnv.CONTENTFUL_DELIVERY_TOKEN,
  env: cfEnv.CONTENTFUL_ENVIRONMENT,
});

let post: any = null;

if (slug && cfEnv.CONTENTFUL_SPACE_ID && cfEnv.CONTENTFUL_DELIVERY_TOKEN) {
  try {
    post = await getRealEstatePostBySlug(cfEnv, slug);
  } catch (e) {
    console.error("[real-estate/[slug]] fetch failed:", e);
    post = null;
  }
} else {
  console.error("[real-estate/[slug]] missing env, skip fetch");
}

if (!post) {
  Astro.response.status = 404;
}

/** RichText → 纯文本（不依赖包） */
function richTextToPlainText(node: any): string {
  if (!node) return "";
  if (typeof node === "string") return node;
  if (Array.isArray(node)) return node.map(richTextToPlainText).join("");
  if (node.nodeType === "text") return node.value || "";
  if (node.content) return node.content.map(richTextToPlainText).join("");
  return "";
}

function normalizeUrl(u?: string) {
  if (!u) return "";
  return u.startsWith("//") ? `https:${u}` : u;
}

/** 类别映射（可选） */
const categoryMap: Record<string, string> = {
  apartment: "公寓",
  "second-hand": "二手房",
  townhouse: "联排别墅",
  "land-villa": "土地别墅",
  commercial: "商业办公",
  land: "土地开发",
  farm: "农场",
  hotel: "酒店",
};

function displayCategory(v: any) {
  const s = String(v ?? "").trim();
  return categoryMap[s] ?? (s || "资讯");
}

// 图片数组
const imageUrlsRaw: string[] = post && Array.isArray(post.imageUrls) ? post.imageUrls : [];
const imageUrls = imageUrlsRaw.map(normalizeUrl).filter(Boolean);

const legacyCover = post ? normalizeUrl(post.image ?? "") : "";
const images = imageUrls.length ? imageUrls : (legacyCover ? [legacyCover] : []);

const heroImage = images[0] ?? "";
const SHOW_FIRST_THUMB = true;
const thumbs = SHOW_FIRST_THUMB ? images : images.slice(1);

// 文本
const bodyText = post ? richTextToPlainText(post.body) : "";
const pageTitle = post?.title ? String(post.title) : "404：找不到该文章";
---

<TemplateLayout title={pageTitle}>
  <section class="tpl-page">
    <div class="tpl-card">
      {post ? (
        <>
          <div class="meta">
            <span class="tag">{displayCategory(post.category)}</span>
            <span class="date">
              {post.publishDate ? new Date(post.publishDate).toLocaleDateString("zh-CN") : ""}
            </span>
          </div>

          <h1 class="h1">{post.title}</h1>

          {heroImage ? (
            <div class="hero-wrap" data-gallery>
              <img
                class="hero"
                src={heroImage}
                alt={post.title}
                loading="eager"
                decoding="async"
                data-hero
              />

              {thumbs.length > 1 ? (
                <div class="thumbs" data-thumbs>
                  {thumbs.map((url, idx) => (
                    <button
                      type="button"
                      class={`thumb ${idx === 0 ? "is-active" : ""}`}
                      data-thumb
                      data-src={url}
                      aria-label={`查看图片 ${idx + 1}`}
                    >
                      <img src={url} alt={`${post.title} - ${idx + 1}`} loading="lazy" decoding="async" />
                    </button>
                  ))}
                </div>
              ) : null}
            </div>
          ) : null}

          <div class="body">
            {post.summary ? <p class="summary">{post.summary}</p> : null}

            {bodyText ? (
              <p class="richtext" style="white-space:pre-wrap">{bodyText}</p>
            ) : (
              <p class="richtext" style="opacity:.7">（暂无详细内容）</p>
            )}
          </div>

          <div class="back">
            <a href="/real-estate">← 返回地产资讯</a>
          </div>
        </>
      ) : (
        <>
          <h1 class="h1">404：找不到该文章</h1>
          <p style="opacity:.75;margin:0 0 10px;">
            可能原因：环境变量未注入 / Contentful 没有这个 slug / 文章未发布。
          </p>
          <div class="back">
            <a href="/real-estate">← 返回地产资讯</a>
          </div>
        </>
      )}
    </div>
  </section>

  {/* ✅ 点击缩略图切换大图（修复了无效 return / gallery 空判断） */}
  <script type="module">
    const gallery = document.querySelector("[data-gallery]");
    if (!gallery) {
      // 没有图片就不绑定事件
    } else {
      const hero = gallery.querySelector("[data-hero]");
      const thumbWrap = gallery.querySelector("[data-thumbs]");

      if (hero && thumbWrap) {
        thumbWrap.addEventListener("click", (e) => {
          const btn = e.target?.closest?.("[data-thumb]");
          if (!btn) return;

          const src = btn.getAttribute("data-src");
          if (!src) return;

          hero.setAttribute("src", src);

          thumbWrap
            .querySelectorAll("[data-thumb]")
            .forEach((el) => el.classList.remove("is-active"));

          btn.classList.add("is-active");
        });
      }
    }
  </script>

  <style>
    .tpl-page { max-width:1100px; margin:0 auto; padding:32px 20px 80px; }
    .tpl-card { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:18px; padding:22px; }

    .meta { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .tag { font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.05); }
    .date { font-size:12px; opacity:.7; }

    .h1 { margin:10px 0 16px; font-size:28px; line-height:1.25; }

    .hero-wrap { margin: 10px 0 18px; }
    .hero {
      width: 100%;
      height: auto;
      max-height: 560px;
      object-fit: cover;
      border-radius: 14px;
      display: block;
      background: #f2f3f5;
    }

    .thumbs{
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    .thumb{
      padding: 0;
      border: 2px solid transparent;
      border-radius: 12px;
      overflow: hidden;
      background: transparent;
      cursor: pointer;
      transition: all .2s ease;
    }
    .thumb img{
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
      background: #f2f3f5;
    }
    .thumb:hover{ transform: translateY(-2px); }
    .thumb.is-active{
      border-color: rgba(11, 27, 84, .55);
      box-shadow: 0 10px 26px rgba(0,0,0,.08);
    }

    .summary { font-weight:600; opacity:.9; margin: 10px 0 10px; }
    .body { line-height:1.9; opacity:.95; }
    .richtext { margin: 0; }

    .back { margin-top:18px; }
    .back a { text-decoration:none; color:#0b1b54; font-weight:700; }

    @media (max-width: 576px){
      .thumbs{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .thumb img{ height: 96px; }
      .h1{ font-size: 24px; }
    }
  </style>
</TemplateLayout>