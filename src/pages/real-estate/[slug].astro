---
import TemplateLayout from "../../layouts/TemplateLayout.astro";
import { getAllRealEstateSlugs, getRealEstatePostBySlug } from "../../lib/contentful";

export async function getStaticPaths() {
  const slugs = await getAllRealEstateSlugs();

  return slugs.map(() => ({
    params: { slug },
    props: { slug },
  }));
}

const { slug } = Astro.props as { slug: string };
const post = await getRealEstatePostBySlug(slug);

if (!post) {
  return new Response("Not found", { status: 404 });
}

// 把 Contentful RichText 简单转成纯文本（不依赖额外 npm 包）
function richTextToPlainText(node: any): string {
  if (!node) return "";
  if (typeof node === "string") return node;
  if (Array.isArray(node)) return node.map(richTextToPlainText).join("");
  if (node.nodeType === "text") return node.value || "";
  if (node.content) return node.content.map(richTextToPlainText).join("");
  return "";
}

const bodyText = richTextToPlainText(post.body);
---

<TemplateLayout title={post.title}>
  <section class="tpl-page">
    <div class="tpl-card">
      <div class="meta">
        <span class="tag">{post.category ?? "资讯"}</span>
        <span class="date">
          {post.publishDate ? new Date(post.publishDate).toLocaleDateString("zh-CN") : ""}
        </span>
      </div>

      <h1 class="h1">{post.title}</h1>

      {post.image ? (
        <img class="cover" src={post.image} alt={post.title} loading="lazy" />
      ) : null}

      <div class="body">
        {post.summary ? <p class="summary">{post.summary}</p> : null}
        <p style="white-space:pre-wrap">{bodyText}</p>
      </div>

      <div class="back">
        <a href="/real-estate">← 返回地产资讯</a>
      </div>
    </div>
  </section>

  <style>
    .tpl-page{ max-width:1100px; margin:0 auto; padding:32px 20px 80px; }
    .tpl-card{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:18px; padding:22px; }
    .meta{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.05); }
    .date{ font-size:12px; opacity:.7; }
    .h1{ margin:10px 0 12px; font-size:28px; line-height:1.25; }
    .cover{ width:100%; height:auto; border-radius:14px; margin:10px 0 14px; }
    .summary{ font-weight:600; opacity:.9; }
    .body{ line-height:1.9; opacity:.95; }
    .back{ margin-top:18px; }
    .back a{ text-decoration:none; }
  </style>
</TemplateLayout>