---
import TemplateLayout from "../../layouts/TemplateLayout.astro";
import * as contentful from "../../lib/contentful";

export const prerender = true;

// ✅ 兼容不同导出命名（你现在最少要保证 contentful.ts 里“有一个”能取到所有 slug）
async function getAllSlugsSafe(): Promise<string[]> {
  // 你可能存在的函数名（按你日志和你之前贴的代码做兼容）
  const fn =
    (contentful as any).getAllRealEstateSlugs ||
    (contentful as any).getAllRealEstateSlugs ||
    (contentful as any).getAllRealEstateSlugs;

  if (typeof fn !== "function") return [];
  const slugs = await fn();
  return Array.isArray(slugs) ? slugs.filter(Boolean) : [];
}

// ✅ 兼容不同导出命名（按 slug 拉详情）
async function getPostBySlugSafe(slug: string) {
  const fn =
    (contentful as any).getRealEstatePostBySlug ||
    (contentful as any).getRealEstatePostBySlug ||
    (contentful as any).getRealEstatePostBySlug;

  if (typeof fn !== "function") return null;
  return await fn(slug);
}

export async function getStaticPaths() {
  const slugs = await getAllSlugsSafe();
  return slugs.map((slug) => ({
    params: { slug },
    props: { slug },
  }));
}

const { slug } = Astro.props as { slug: string };
const post = await getPostBySlugSafe(slug);

if (!post) {
  return new Response("Not found", { status: 404 });
}

// RichText -> 纯文本（不依赖 npm）
function richTextToPlainText(node: any): string {
  if (!node) return "";
  if (typeof node === "string") return node;
  if (Array.isArray(node)) return node.map(richTextToPlainText).join("");
  if (node.nodeType === "text") return node.value || "";
  if (node.content) return node.content.map(richTextToPlainText).join("");
  return "";
}

const bodyText = richTextToPlainText((post as any).body);

// ✅ 兼容：你可能返回 image(单张) / imageUrls(多张) / images(多张)
const imageUrlsA =
  Array.isArray((post as any).imageUrls) ? (post as any).imageUrls : [];
const imageUrlsB =
  Array.isArray((post as any).images) ? (post as any).images : [];
const imageSingle =
  (post as any).image ? [(post as any).image] : [];

const images = [...imageUrlsA, ...imageUrlsB, ...imageSingle]
  .filter(Boolean)
  .map((u: string) => (u.startsWith("//") ? `https:${u}` : u));

const cover = images[0] ?? "";
---

<TemplateLayout title={(post as any).title ?? "地产资讯"}>
  <section class="tpl-page">
    <div class="tpl-card">
      <div class="meta">
        <span class="tag">{(post as any).category ?? "资讯"}</span>
        <span class="date">
          {(post as any).publishDate
            ? new Date((post as any).publishDate).toLocaleDateString("zh-CN")
            : ""}
        </span>
      </div>

      <h1 class="h1">{(post as any).title ?? ""}</h1>

      {cover ? <img class="cover" src={cover} alt={(post as any).title ?? "cover"} loading="lazy" /> : null}

      {images.length > 1 ? (
        <div class="gallery">
          {images.map((u, idx) => (
            <a class="g-item" href={u} target="_blank" rel="noreferrer">
              <img src={u} alt={`${(post as any).title ?? "img"} - ${idx + 1}`} loading="lazy" />
            </a>
          ))}
        </div>
      ) : null}

      <div class="body">
        {(post as any).summary ? <p class="summary">{(post as any).summary}</p> : null}
        {bodyText ? <p class="content" style="white-space:pre-wrap">{bodyText}</p> : null}
      </div>

      <div class="back">
        <a href="/real-estate">← 返回地产资讯</a>
      </div>
    </div>
  </section>

  <style>
    .tpl-page { max-width:1100px; margin:0 auto; padding:32px 20px 80px; }
    .tpl-card { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:18px; padding:22px; }
    .meta { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .tag { font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.05); }
    .date { font-size:12px; opacity:.7; }
    .h1 { margin:10px 0 12px; font-size:28px; line-height:1.25; }
    .cover { width:100%; height:auto; border-radius:14px; margin:10px 0 14px; display:block; }

    .gallery { display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:14px; margin:10px 0 18px; }
    .g-item { display:block; border-radius:12px; overflow:hidden; background:#f3f5fb; border:1px solid rgba(0,0,0,.06); text-decoration:none; }
    .g-item img { width:100%; height:210px; object-fit:cover; display:block; transition:transform .25s ease; }
    .g-item:hover img { transform:scale(1.03); }
    @media (max-width:992px) { .gallery{ grid-template-columns:repeat(2, minmax(0,1fr)); } .g-item img{ height:200px; } }
    @media (max-width:576px) { .gallery{ grid-template-columns:1fr; } .g-item img{ height:220px; } }

    .summary { font-weight:600; opacity:.9; margin:0 0 10px; }
    .body { line-height:1.9; opacity:.95; }
    .content { margin:0; }
    .back { margin-top:18px; }
    .back a { text-decoration:none; }
  </style>
</TemplateLayout>