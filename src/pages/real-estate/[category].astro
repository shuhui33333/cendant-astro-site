---
import TemplateLayout from "../../../layouts/TemplateLayout.astro";
import SubpageIntroBanner from "../../../components/SubpageIntroBanner.astro";
import { getRealEstatePosts } from "../../../lib/contentful";

/**
 * URL 例子：
 * /real-estate/sale/apartment
 * /real-estate/sale/townhouse
 */
const { category } = Astro.params;

/** 你的分类映射（可随时增删） */
const SALE_CATS: Record<string, { zh: string; en: string; intro: string }> = {
  "apartment": {
    zh: "公寓",
    en: "APARTMENT",
    intro: "公寓选购要点、楼盘对比、租金回报与风险提示。",
  },
  "second-hand": {
    zh: "二手房",
    en: "SECOND HAND",
    intro: "看房清单、议价策略、验房要点与交易流程。",
  },
  "townhouse": {
    zh: "联排别墅",
    en: "TOWNHOUSE",
    intro: "地段选择、户型配置、社区配套与投资逻辑。",
  },
  "land-villa": {
    zh: "土地别墅",
    en: "LAND VILLA",
    intro: "土地+建房组合、预算规划、交付节点与风险控制。",
  },
  "commercial": {
    zh: "商业办公楼",
    en: "COMMERCIAL",
    intro: "租约结构、现金流分析、核心地段趋势与注意事项。",
  },
  "land": {
    zh: "土地开发",
    en: "LAND DEVELOPMENT",
    intro: "规划评估、开发流程、成本测算与风险提示。",
  },
  "farm": {
    zh: "农场",
    en: "FARM",
    intro: "用途评估、土地指标、合规要求与经营建议。",
  },
  "hotel": {
    zh: "酒店",
    en: "HOTEL",
    intro: "经营模型、牌照合规、回报测算与交易要点。",
  },
};

/** 兜底：如果 URL category 不在映射里 */
const catMeta = SALE_CATS[category ?? ""] ?? {
  zh: "分类",
  en: (category ?? "CATEGORY").toUpperCase(),
  intro: "查看该分类下的最新资讯与发布内容。",
};

/**
 * ⚠️ 这里我用“拉一批 -> 本地过滤”的方式，避免你 Contentful 还没写专门的 query 方法导致报错
 * 你可以先用 200，如果文章更多再加大或做分页
 */
const all = await getRealEstatePosts(200);

/**
 * ✅ 过滤逻辑（你需要按你 Contentful 字段微调）
 * - 假设：p.type / p.kind / p.purpose 里有 "sale"
 * - 假设：p.category / p.subCategory 里包含 category 或中文名
 */
const salePosts = (all ?? []).filter((p: any) => {
  const type = String(p.type ?? p.kind ?? p.purpose ?? "").toLowerCase();
  const c1 = String(p.category ?? p.subCategory ?? "").toLowerCase();
  const c2 = String(p.categoryZh ?? p.categoryCn ?? "").toLowerCase();
  const slug = String(p.categorySlug ?? "").toLowerCase();

  const isSale = type.includes("sale") || type.includes("sell") || type.includes("出售");
  const isCat =
    c1.includes(String(category).toLowerCase()) ||
    slug === String(category).toLowerCase() ||
    c2.includes(catMeta.zh.toLowerCase());

  // 如果你目前 Contentful 没区分 sale/rent，可以先只按类别过滤：
  return (isSale || type === "") && isCat;
});
---

<TemplateLayout title={`房产售卖资讯 · ${catMeta.zh}`}>
  <!-- 顶部 Banner：沿用你的 SubpageIntroBanner 模板风格 -->
  <SubpageIntroBanner
    titleZh={`房产售卖资讯 · ${catMeta.zh}`}
    titleEn={`FOR SALE · ${catMeta.en}`}
    subtitle={catMeta.intro}
    items={[]}
  />

  <section class="re-wrap section-padding">
    <div class="container">

      <div class="re-breadcrumb">
        <a href="/real-estate">房产资讯</a>
        <span class="sep">/</span>
        <a href="/real-estate">售卖资讯</a>
        <span class="sep">/</span>
        <span class="current">{catMeta.zh}</span>
      </div>

      <div class="section-title re-title">
        <h2>最新内容</h2>
      </div>

      {salePosts.length > 0 ? (
        <div class="blog-grid">
          {salePosts.map((p: any) => (
            <a class="blog-card" href={`/real-estate/${p.slug}`}>
              <div class="blog-content">
                <span class="blog-tag">{p.category ?? catMeta.zh}</span>
                <h4>{p.title}</h4>
                {p.publishDate && (
                  <p class="blog-date">
                    {new Date(p.publishDate).toLocaleDateString("zh-CN")}
                  </p>
                )}
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="empty">
          <p><strong>该分类暂时还没有发布内容。</strong></p>
          <p>你可以在 Contentful 发布该分类文章后，这里会自动显示。</p>
        </div>
      )}

    </div>
  </section>
</TemplateLayout>

<style>
.re-wrap { padding-top: 10px; }

.re-breadcrumb{
  font-size: 13px;
  color: #7b8494;
  margin: 8px 0 18px;
}
.re-breadcrumb a{ color:#0b1b54; text-decoration:none; }
.re-breadcrumb .sep{ margin: 0 8px; opacity:.6; }
.re-breadcrumb .current{ color:#0b1b54; font-weight:700; }

.section-title.re-title{ margin: 0 0 16px; }
.section-title.re-title h2{
  font-size: 22px !important;
  line-height: 1.25 !important;
  font-weight: 800;
  letter-spacing: .5px;
  color: #0b1b54;
  margin: 0;
}
.section-title.re-title h2::after{
  content:"";
  display:block;
  width:56px;
  height:3px;
  background:#f2a23a;
  border-radius:999px;
  margin-top:10px;
}

.blog-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap:22px;
}
.blog-card{
  display:block;
  padding:20px;
  background:#fff;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.06);
  text-decoration:none;
  transition: all .25s ease;
}
.blog-card:hover{
  transform: translateY(-3px);
  box-shadow: 0 10px 26px rgba(0,0,0,.08);
}
.blog-tag{
  font-size:12px;
  color:#5b6474;
  display:inline-block;
  margin-bottom:8px;
}
.blog-card h4{
  margin:0;
  font-size:16px;
  font-weight:800;
  line-height:1.35;
  color:#0b1b54;
}
.blog-date{
  font-size:12px;
  color:#8a93a3;
  margin-top:8px;
}

.empty{
  padding:34px;
  text-align:center;
  background:#fff;
  border-radius:12px;
  border:1px dashed rgba(11,27,84,.25);
}

@media (max-width:768px){
  .section-title.re-title h2{ font-size:18px !important; }
}
</style>